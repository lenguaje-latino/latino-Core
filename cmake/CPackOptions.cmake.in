# Opciones adicionales de CPack para NSIS (inyectadas durante cpack)
set(CPACK_NSIS_EXTRA_INSTALL_COMMANDS [[
; Asociación de archivos .lat como en 1.4.4 (ProgID Latino.File)
WriteRegStr HKCR ".lat" "" "Latino.File"
WriteRegStr HKCR "Latino.File" "" "Archivo LAT de Latino"
WriteRegStr HKCR "Latino.File\\DefaultIcon" "" "$INSTDIR\resources\icons\latino_archivo_Win.ico, 1"
WriteRegStr HKCR "Latino.File\\shell\\open\\command" "" '"$INSTDIR\bin\latino.exe" "%1"'
System::Call 'shell32::SHChangeNotify(i 0x08000000, i 0x0000, p 0, p 0)'
StrCmp $INSTALL_DESKTOP "1" CreateDesktopShortcut skipDesktop
CreateDesktopShortcut:
  CreateShortCut "$DESKTOP\Latino.lnk" "$INSTDIR\bin\latino.exe" "" "$INSTDIR\bin\latino.ico" 0
skipDesktop:
StrCpy $DO_NOT_ADD_TO_PATH "1"
StrCmp $ADD_TO_PATH_ALL_USERS "1" AddPathAllUsers checkCurrent
AddPathAllUsers:
  ReadRegStr $0 HKLM "SYSTEM\CurrentControlSet\Control\Session Manager\Environment" "Path"
  StrCpy $1 "$INSTDIR\bin"
  Push "$0;" 
  Push "$1;"
  Call StrStr
  Pop $2
  StrCmp $2 "" 0 PathAllDone
  StrCpy $3 "$0;$1"
  WriteRegExpandStr HKLM "SYSTEM\CurrentControlSet\Control\Session Manager\Environment" "Path" $3
  SendMessage ${HWND_BROADCAST} ${WM_WININICHANGE} 0 "STR:Environment" /TIMEOUT=5000
  Goto PathAllDone
checkCurrent:
StrCmp $ADD_TO_PATH_CURRENT_USER "1" AddPathCurrent PathAllDone
AddPathCurrent:
  ReadRegStr $0 HKCU "Environment" "Path"
  StrCpy $1 "$INSTDIR\bin"
  Push "$0;" 
  Push "$1;"
  Call StrStr
  Pop $2
  StrCmp $2 "" 0 PathAllDone
  StrCpy $3 "$0;$1"
  WriteRegExpandStr HKCU "Environment" "Path" $3
  SendMessage ${HWND_BROADCAST} ${WM_WININICHANGE} 0 "STR:Environment" /TIMEOUT=5000
PathAllDone:
]])

set(CPACK_NSIS_EXTRA_UNINSTALL_COMMANDS [[
; Limpieza de asociación de archivos .lat (ProgID Latino.File)
DeleteRegKey HKCR ".lat"
DeleteRegKey HKCR "Latino.File"
]])
